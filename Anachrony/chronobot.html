<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" sizes="180x180" href="favicon-180.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">

    <link rel="stylesheet" type="text/css" href="css/modal.css">

    <script src="https://pixijs.download/release/pixi.min.js"></script>
    <script src="https://filters.pixijs.download/v3.1.1/pixi-filters.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/micromodal/dist/micromodal.min.js"></script>
    <script src="numbertokens.js"></script>
    <script src="statictokens.js"></script>
    <script src="slidetokens.js"></script>
    <script src="counter.js"></script>
    <script src="button.js"></script>
    <script src="rainbowFrame.js"></script>
    <script src="paradox.js"></script>
    <script src="autoScale.js"></script>
    <title>Chronobot</title>
</head>

<body style="padding:0;margin:0">

<canvas id="mycanvas"></canvas>
<!-- The Modals -->
<!--InfoWindow-->
<div id="myModal" class="modalI">

  <!-- Modal content -->
  <div class="modalI-content">
    <p id="infotext"></p>
    <div style="text-align: right">
      <button name="OK" class="button" onclick="modalI.style.display = 'none'" >OK</button>
    </div>
  </div>

</div>

<!--SelectWindow-->

<div id="myModal2" class="modalS">

  <!-- Modal content -->
  <div class="modalS-content">
    <div class = "selections">
    <select class="myselect" id="Key" onchange="keySelected()">
      <option value="none">---</option>
      <option value="t2">Position Token 2</option>
      <option value="t3">Position Token 3</option>
      <option value="t4">Position Token 4</option>
      <option value="t5">Position Token 5</option>
      <option value="rn"># Neutronium</option>
      <option value="ru"># Uranium</option>
      <option value="rg"># Gold</option>
      <option value="rt"># Titanium</option>
      <option value="wg"># Geniuses</option>
      <option value="wa"># Admins</option>
      <option value="we"># Engineers</option>
      <option value="ws"># Scientists</option>
      <option value="xt">Position Time Travel Track</option>
      <option value="exo"># Exosuits</option>
      <option value="bp"># Power Plants</option>
      <option value="bf"># Factories</option>
      <option value="bh"># Habitats</option>
      <option value="bl"># Labs</option>
      <option value="ba"># Anomalies</option>
      <option value="bs"># Superprojects</option>
      <option value="hc"># Breakthroughs Circle</option>
      <option value="ht"># Breakthroughs Triangle</option>
      <option value="hs"># Breakthroughs Square</option>
      <option value="points">Points</option>
      <option value="background">Background Image</option>
    </select>
      &emsp;
    <select class= "myselect" id="Value" disabled>
    </select>
    </div>
    <BR>
    <div><label>MODULE</label></div><BR>
    <div>
    	<input type="checkbox" name="VarAnomalies" id="VarAnomalies">
    	<label>Variable Anomalies</label>
    </div>
    <div>
    	<label>INCREASING THE DIFFICULTY</label>
    </div>
    <BR>
    <div class="">
    	<input type="checkbox" name="skipReboot" id="skipReboot">
    	<label>Skip Reboot</label>
    </div>
    <BR>
    <div>
    	<label>Minimum number of Chronobot's Actions: </label>
    	<select class="myselect" id="MinActionValue" onchange="">
    		<option value="3">3</option>
    		<option value="4">4</option>
    		<option value="5">5</option>
    		<option value="6">6</option>
    	</select>
    </div>
<!--
    <BR>
    <div class="">
        <input type="checkbox" name="additionalTurn" id="additionalTurn">
        <label>The Chronobot takes one additional turn after you have passed.</label>
    </div>
-->
    <div style="text-align: right">
      <button name="cancel" class="button" onclick="modalS.style.display = 'none'" >Cancel</button>
      <button name="ok" class="button" onclick="valueSelected()" >OK</button>
    </div>
  </div>

</div>

<script src="editmode.js"></script>
<script src="infotext.js"></script>
<script>

    const global_steps = 30;
	let global_scaling = 1;
	const defaultW = 1480+250;
	const defaultH = 1080;

	updateScale()

    class Board extends PIXI.Sprite{

        constructor(texture) {
            super(texture);
	        this.setCollectionComplete = false;
        }


        validateWorkers(){
            if (scientistToken.number>0 && engineerToken.number>0 && adminToken.number>0 && geniusToken.number>0) {
            	this.setCollectionComplete = true;
                scientistToken.remove();
                engineerToken.remove();
                adminToken.remove();
                geniusToken.remove();
                points.increase(5);
                actionText.text += "\nComplete Worker Set\nAdded 5 VP\n\n"
            }
            this.setCollectionComplete = false;
        }

        validateResources(){
            if (neutroniumToken.number>0 && uraniumToken.number>0 && goldToken.number>0 && titaniumToken.number>0) {
            	this.setCollectionComplete = true;
                neutroniumToken.remove();
                uraniumToken.remove();
                goldToken.remove();
                titaniumToken.remove();
                points.increase(5);
                actionText.text += "\nComplete Resource\nSet -> Added 5 VP\n\n"
            }
            this.setCollectionComplete = false;
        }

        validateParadoxes(){
            if ( paradox.isFull() ) {
                if ( anomaly.belowLimit() ) {
                    paradox.emptyAll();

                    actionText.text += "Gain an Anomaly\n"
                    anomaly.add();

                	if( warptileNumber < maxWarpTile) {
    	            	// indexOfMaxValue will return 1+ as 0 is handled by the prevous if statement
    	            	let indexOfMaxValue = warpTokensLog.indexOf(Math.max(...warpTokensLog));
    	            	if( indexOfMaxValue < era.number - 1 ) {
    	            		// have warp tile in the past
    		            	actionText.text += "Remove Warp tile\nfrom Era " + (indexOfMaxValue + 1) + "\n";
    		            	warpTokensLog[indexOfMaxValue] -= 1;
    		                warptileNumber += 1;
    		            }
    	            }
                } else {
                    actionText.text += "Anomaly is Full\n"
                    paradox.emptyAll();                    
                    failedAction();
                }

            }
        }

        checkIfReady(target) {
            if (action === 1 || action === 3 || action === 6 || action === 8 || action === 11) {
                button1.label.text = "Continue";
                button1.settings.onTap = () => acceptAction();
                button1.visible = true;
            } else if (action === 5){
				if ( ! this.setCollectionComplete ) {
		        	actionText.text += "took " + target.name + "\n";
					selectResources +=1;
				}
            	if (selectResources === 1) {
                    button1.label.text="Continue (1)";
                    button1.visible = true;
                    button1.settings.onTap = () => acceptAction();            		
            	} else if (selectResources >= 2) {
                    resourcesFrame.attentionOff();
                    neutroniumToken.interactive = false;
                    uraniumToken.interactive = false;
                    goldToken.interactive = false;
                    titaniumToken.interactive = false;
                    button1.label.text="Continue";
                    button1.visible = true;
                    button1.settings.onTap = () => acceptAction();
                }
            } else if (action === 7) {
                if( ! this.setCollectionComplete ) {
    	        	actionText.text += "took " + target.name + "\n";
                    geniusWorkerFrame.attentionOff();
                    workersFrame.attentionOff();
                    adminToken.interactive = false;
                    engineerToken.interactive = false;
                    scientistToken.interactive = false;
                    geniusToken.interactive = false;
                    //+1vp
                    points.increase(1);
                    actionText.text += "\nRecruit bonus\n+1 VP\n"

                    button1.label.text="Continue";
                    button1.settings.onTap = () => acceptAction();
                }
            } else if (action === 10 || action === 10.5) {
	        	actionText.text += "took " + target.name + "\n";
                geniusWorkerFrame.attentionOff();
                geniusToken.interactive = false;
                //+1vp
                points.increase(1);
                actionText.text += "\nRecruit bonus\n+1 VP\n"

                button1.label.text="Continue";
                button1.settings.onTap = () => acceptAction();            	
            }
        }
    }

    const canvas = document.getElementById('mycanvas');

    const automa = new PIXI.Application({
        view: canvas,
        width: defaultW * global_scaling,
        height: defaultH * global_scaling,
        resolution: 1,
        autoDensity: true
    });

    automa.stage.scale.x=global_scaling;
    automa.stage.scale.y=global_scaling;

    let loader = PIXI.Loader.shared;
    loader.add('images/BG-TheWorld.png');
    loader.add('images/BG-Chronossus.png');    
    loader.add('images/Chronobot-2.0-board.png');
    loader.add('images/sidepanel-up.png');
    loader.add('images/sidepanel-down.png');

    loader.add("images/anomaly.png");
    for( let i = 1; i <= 4; i++ ) {
        loader.add("images/VictoryPointTokenNeg" + i + ".png");
    }
    loader.add("images/VPHightlighter.png");

    loader.add('images/power.png');
    loader.add('images/factories.png');
    loader.add('images/habitats.png');
    loader.add('images/lab.png');
    for( let i = 0; i <= 8; i++ ) {
        loader.add("images/VictoryPointToken" + i + ".png");
    }

    loader.add("images/superproject.png");

    loader.onComplete.add(startAutoma);
    loader.load();

    const board = new Board(PIXI.Texture.EMPTY);

    const maxWarpTile = 8;
    let warptileNumber = maxWarpTile;
    let botActions = 0;
    let dice = 1;
    let action = 0;
    let selectResources = 0;
    let finalTimeTravel = false;

    const aiDiceValue = [2, 3, 3, 4, 4, 5];

    const states = {};
    const statePos = [{x: 144, y: 106}, {x: 304, y: 106}, {x: 464, y: 106}, {x: 625, y: 106},
	  		          {x: 144, y: 460}, {x: 304, y: 460}, {x: 464, y: 460}, {x: 625, y: 460},
			          {x: 625, y: 622}, {x: 464, y: 622}, {x: 304, y: 622}, {x: 144, y: 622}];
    const stateTransition = {1: 2, 2: 3, 3: 4, 4: 1,
							 5: 6, 6: 7, 7: 8, 8: 9,
							 9: 10, 10: 11, 11: 12, 12: 5};
    const stateStart = [8, 1, 6, 12];

    for (let i = 1; i <= 12; i++) {
        states[i] = new State(i, statePos[i - 1]);
    }

    for (const [key, value] of Object.entries(states)) {
        value.setNext(states[stateTransition[key]])
    }

    const noIcon = new PIXI.Sprite(PIXI.Texture.EMPTY);

    const tokens = [];

    const workerPositions = [{x: 974, y: 34}, {x: 974, y: 167}, {x: 974, y: 302}, {x: 974, y: 436}]

    const genius_texture = PIXI.Texture.from('images/genius.png');
    const admin_texture = PIXI.Texture.from('images/admin.png');
    const engineer_texture = PIXI.Texture.from('images/engineer.png');
    const scientist_texture = PIXI.Texture.from('images/scientist.png');
    const geniusToken = new WorkerToken(genius_texture, "Genius", workerPositions[0], 0);
    const adminToken = new WorkerToken(admin_texture, "Administrator", workerPositions[1], 0);
    const engineerToken = new WorkerToken(engineer_texture, "Engineer", workerPositions[2], 0);
    const scientistToken = new WorkerToken(scientist_texture, "Scientist", workerPositions[3], 0);

    const workerFrameTexture = PIXI.BaseTexture.from('images/WorkersOuterFrame.png');
    const geniusWorkerTexture = new PIXI.Texture( workerFrameTexture, new PIXI.Rectangle(0,0,86,130) );
    const otherWorkersTexture = new PIXI.Texture( workerFrameTexture, new PIXI.Rectangle(0,131,86,387) );
/*
    const geniusWorkerFrame = new RainbowFrame(geniusWorkerTexture, {x: 0, y: 31});
    const workersFrame = new RainbowFrame(otherWorkersTexture, {x: 100, y: 161});
*/
    const geniusWorkerFrame = new WhiteRedRainbowFrame(geniusWorkerTexture, {x: 970, y: 31});
    const workersFrame = new WhiteRedRainbowFrame(otherWorkersTexture, {x: 970, y: 161});

    const resourcePositions = [{x: 828, y: 58}, {x: 828, y: 191}, {x: 828, y: 326}, {x: 828, y: 460}]
    const neutronium_texture = PIXI.Texture.from('images/neutronium.png');
    const uranium_texture = PIXI.Texture.from('images/uranium.png');
    const gold_texture = PIXI.Texture.from('images/gold.png');
    const titanium_texture = PIXI.Texture.from('images/titanium.png');
    const neutroniumToken = new ResourceToken(neutronium_texture, "Neutronium", resourcePositions[0], 0);
    const uraniumToken = new ResourceToken(uranium_texture, "Uranium", resourcePositions[1], 0);
    const goldToken = new ResourceToken(gold_texture, "Gold", resourcePositions[2], 0);
    const titaniumToken = new ResourceToken(titanium_texture, "Titanium", resourcePositions[3], 0);
    const resourcesTokens = [neutroniumToken, uraniumToken, goldToken, titaniumToken];

    const resourcesFrame = new WhiteRedRainbowFrame(PIXI.Texture.from('images/ResourceOuterFrame.png'), {x: 799, y: 30});
/*
// remove supply, no longer have supply in v2.0 
    const supplyPositions = {0: {x: 743, y: 350}, 1: {x: 810, y: 315}, 2: {x: 878, y: 315}, 3: {x: 945, y: 315}};
    const supplyTransitions = {0: 1, 1: 2, 2: 3, 3: 3};
    const supplyToken = new SlideToken(PIXI.Texture.from('images/supply.png'), 0, supplyPositions, supplyTransitions);
    const supplyNeed = [5, 6, 7, 7];
    const supplyPoints = [0,2,5,8];
// remove supple end
*/

    const timetravelPositions = {
        0: {x: 858, y: 719}, 1: {x: 926, y: 719}, 2: {x: 992, y: 719}, 3: {x: 1060, y: 719},
        4: {x: 1126, y: 719}, 5: {x: 1194, y: 719}, 6: {x: 1260, y: 719}
    };
    const timetravelTransitions = {0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 6};
    const timetravelToken = new SlideToken(PIXI.Texture.from('images/timetravel.png'), 0,
        timetravelPositions, timetravelTransitions);
    const timeTravelPoints = [0,2,4,6,8,10,12];



    const powerPlantIcon = new PIXI.Sprite(PIXI.Texture.from('images/powerplantIcon.png'));
    const factoryIcon = new PIXI.Sprite(PIXI.Texture.from('images/factoryIcon.png'));
    const habitatIcon = new PIXI.Sprite(PIXI.Texture.from('images/habitatIcon.png'));
    const labIcon = new PIXI.Sprite(PIXI.Texture.from('images/labIcon.png'));
    const icons = [powerPlantIcon,factoryIcon,habitatIcon,labIcon];
    for (let i=0; i<=3; i++) {
        icons[i].x = 636 + i * 179;
        icons[i].y = 959;
        icons[i].visible = false;
        icons[i].anchor.set(0.5);
    }
    const superprojectIcon = new PIXI.Sprite(PIXI.Texture.from('images/SuperprojectIcon.png'));
    superprojectIcon.x = 344;
    superprojectIcon.y = 959;
    superprojectIcon.visible = false;
    superprojectIcon.anchor.set(0.5);


    const powerPlantBack = new TokenWithScores(loader.resources["images/power.png"].texture, powerPlantIcon, "Power Plant", {x: 549, y: 861}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png"));
    
    const factoryBack = new TokenWithScores(loader.resources["images/factories.png"].texture, factoryIcon, "Factory", {x: 728, y: 861}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png"));
    const habitatBack = new TokenWithScores(loader.resources["images/habitats.png"].texture, habitatIcon, "Habitat", {x: 907, y: 861}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png"));
    
    const labBack = new TokenWithScores(loader.resources["images/lab.png"].texture, labIcon, "Lab", {x: 1086, y: 861}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png"));

    const breakthroughBack = new PIXI.Sprite(PIXI.Texture.from('images/BreakthroughIcon.png'));
    breakthroughBack.x = 16;
    breakthroughBack.y = 891;
    breakthroughBack.visible = false;

    let VarAnomalies = false;
    const anomalyTexture = loader.resources["images/anomaly.png"].texture;
    const anomaly = new TokenWithScores( anomalyTexture, noIcon, "Anomaly", {x: 1291, y: 861}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png") );

    const superProjectBack = new TokenWithScores(loader.resources['images/superproject.png'].texture, superprojectIcon, "Superproject", {x: 169, y: 859}, 0, true, 3, PIXI.Texture.from("images/VPHightlighter.png"));
    superProjectBack.text.position = {x: 175, y: 165};

    const exoSuitBack = new StaticToken(PIXI.Texture.from('images/exosuit.png'), noIcon, "Exosuit", {x: 1125, y: 43}, 0, true, 6);
    exoSuitBack.text.position = {x: 105, y: 95};

    const advancePath = new PIXI.Sprite(PIXI.Texture.from('images/advancePath.png'));
    advancePath.x = 505;
    advancePath.y = 501;
    advancePath.visible = skipReboot;

    const normalPath = new PIXI.Sprite(PIXI.Texture.from('images/normalPath.png'));
    normalPath.x = 505;
    normalPath.y = 501;
    normalPath.visible = ! skipReboot;


	const cogWheelIcon = new PIXI.Sprite(PIXI.Texture.from('images/cogwheel.png'));
	cogWheelIcon.on('pointerdown',editRequested );
	cogWheelIcon.x = 1412;
	cogWheelIcon.y = 8;
	cogWheelIcon.interactive = true;

	const points = new Counter({x: 140, y: 185}, 0, 999);
    const era = new Counter({x: 220, y: 52}, 1, 10);
    const phase = new Counter({x: 220, y: 110}, 1, 6);
    const btCircleCounter = new Counter({x: 90, y: 925}, 0, 9);
    btCircleCounter.scale.set(.7);
    btCircleCounter.visible = false;
    const btTriangleCounter = new Counter({x: 90, y: 959}, 0, 9);
    btTriangleCounter.scale.set(.7);
    btTriangleCounter.visible = false;
    const btSquareCounter = new Counter({x: 90, y: 993}, 0, 9);
    btSquareCounter.scale.set(.7);
    btSquareCounter.visible = false;
    const researchCounter = [btCircleCounter,btTriangleCounter,btSquareCounter];
    const researchItem = ["Circle", "Triangle", "Square"];

    // warp token count of each era. warpTokensLog[era.number -1]
    const warpTokensLog = [];

    actionText = new PIXI.Text("action to do \n sddf ", {
        fontFamily: 'Arial',
        fontSize: 24, fontWeight: 'normal', fill: 0x433656, align: 'center'
    });
    actionText.anchor = {x: .5, y: 0};
    actionText.position = {x: 125, y: 250};
    actionText.visible = false;

    const paradox = new Paradox();

    button0 = new Button({
        label: 'Action space\nfree',
        width: 250,
        height: 150,
        x: 125,
        y: 5,
        onTap: () => spaceFree()
    })


    button1 = new Button({
        label: 'Next\nBot Action',
        width: 250,
        height: 150,
        x: 125,
        y: 155,
        onTap: () => button1Pressed()
    })

    button2 = new Button({
        label: 'Next Phase',
        width: 250,
        height: 150,
        x: 125,
        y: 305,
        onTap: () => button2Pressed()
    })

    button1.visible = false;
    button0.visible = false;

    function button2Pressed() {

        // once game started disable switching to varialbe Anomalies
        // document.getElementById("VarAnomalies").disabled = true;

        button1.enable();

        if (phase.number === 1) {
            phase.set(2);
            button2Pressed();
        } else if (phase.number === 2) {
        	/*
        	use the button to perform digital roll
        	click the roll button to roll the paradox die and assign token
        	need to keep track of paradox token amount and skip rolling is take Anomaly and remove one warp token 
        	*/
            actionText.text = "PARADOX PHASE\n";
            actionText.text += "Chronobot rolls\n for Paradoxes last \n add Paradoxes\n on board by tapping\n ";
            actionText.visible = true;
            paradox.activateTokens();

            button1.label.text = "Roll\nParadox Dice";
            button1.settings.onTap = () => button1Pressed();
            button2.label.text = "Done \nNext Phase";
            button2.settings.onTap = () => waitForUser();
        } else if (phase.number === 3) {
            let exoNumber = 6;
            if (era.number > 4) exoNumber = 4;
            actionText.text = "POWER UP PHASE\n\nChronobot\ncharged up \n" + exoNumber.toString() + " exosuits\n Charge yours!";
            actionText.visible = true;

            exoSuitBack.set(exoNumber);
            button2.label.text = "Done \nNext Phase";
            button2.settings.onTap = () => waitForUser();

        } else if (phase.number === 4) {
            actionText.text = "WARP PHASE\n";
            for( var i = 0; i < warpTokensLog.length && i < era.number; i++ ) {
                actionText.text += "Era " + (i+1) + ": " + warpTokensLog[i] + " warp token";
                if( warpTokensLog[i] > 1 ) actionText.text += "s";
                actionText.text += "\n";
            }
            actionText.text += "\nSelect your warp tiles!";
            actionText.visible = true;

            button2.label.text = "Done";
            button2.settings.onTap = () => waitForUser();
        } else if (phase.number === 5) {
            actionText.text = "Perform your Action \nor ask for \n Chronobot Action";
            actionText.visible = true;

            button1.visible = true;
            button1.label.text = 'Next\nBot Action';

            button2.label.text = "Continue to\nnext Phase";
            button2.disable();
            botActions = 0;
            button2.settings.onTap = () => waitForUser();
        }
    }

    function button1Pressed() {
        if (phase.number === 2) {
            rollResult = paradoxDieValue();

        } else if (phase.number === 5) {
	        if (exoSuitBack.number > 0) {
	            dice = aiDiceValue[Math.floor(Math.random() * 6)];
	            actionText.text = "Chronobot rolled a " + dice.toString() + "\n This means:\n\n";
	            actionText.visible = true;
	            action = tokens[dice - 2].state.name;
	            performAction();
	        } else if (!finalTimeTravel) {
                action = 2;
                finalTimeTravel = true;
                performAction();
	            
			}
        } else if (phase.number === 6) {
            const btVp = btSquareCounter.number + btTriangleCounter.number + btCircleCounter.number
                + 2 *  Math.min(btSquareCounter.number,btTriangleCounter.number,btCircleCounter.number);
            let totalVP = 0;
            actionText.text = "Game ended\n\n";
            actionText.text += "Gain: " + points.number + " VPs\n";
            totalVP += points.number;

            actionText.text += "Breakthrough: "+ btVp.toString() +" VPs,\n";
            totalVP += btVp;
            
            actionText.text += "Time Travel: " + timeTravelPoints[timetravelToken.state] + " VPs\n";
            totalVP += timeTravelPoints[timetravelToken.state];
            
            actionText.text += "Power Plant: " + powerPlantBack.getTotalVP() + " VPs\n";
            totalVP += powerPlantBack.getTotalVP();
            
            actionText.text += "Factory: " + factoryBack.getTotalVP() + " VPs\n";
            totalVP += factoryBack.getTotalVP();
            
            actionText.text += "Life Support: " + habitatBack.getTotalVP() + " VPs\n";
            totalVP += habitatBack.getTotalVP();
            
            actionText.text += "Lab: " + labBack.getTotalVP() + " VPs\n";
            totalVP += labBack.getTotalVP();

            actionText.text += "Superproject: " + superProjectBack.getTotalVP() + " VPs\n";
            totalVP += superProjectBack.getTotalVP();

            actionText.text += "Anomaly: " + anomaly.getTotalVP() + " VPs\n";
            totalVP += anomaly.getTotalVP();
            
            actionText.text += "\nTotal: " + totalVP.toString() + " VPs.";
            actionText.visible = true;
            button1.visible = false;
            button2.visible = false;
        }
    }

    function performAction() {
        button2.disable();
        let number = action;
        if (number === 1) {  
        	// Take Habitat
 			// ask if space is free
            actionText.text += "CONSTRUCT\na HABITAT\n";
            habitatBack.attentionOn();
            button0.visible = true;
            button0.label.text = "Construct Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Construct Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (number === 2) {  
        	// Time travel
        	actionText.text += "TIME TRAVEL\n"
            if (timetravelToken.state === 6) {
                actionText.text += "time travel maxed\n";
                failedAction();
            } else {
            	if( warptileNumber < maxWarpTile) {
	            	// indexOfMaxValue will return 1+ as 0 is handled by the prevous if statement
	            	let indexOfMaxValue = warpTokensLog.indexOf(Math.max(...warpTokensLog));
	            	if( indexOfMaxValue < era.number - 1 ) {
	            		// have warp tile in the past
		            	actionText.text += "Remove Warp tile\nfrom Era " + (indexOfMaxValue + 1) + "\n";
		            	warpTokensLog[indexOfMaxValue] -= 1;
		                warptileNumber += 1;
		                actionText.text += "Chronobot advanced\n time travel\n";
		                timetravelToken.advance();
		            } else {
		            	actionText.text += "No Warp tile\nin the past\n";
		            	failedAction();
		            }
            	} else {
            		actionText.text += "No Warp tile\n";
            		failedAction();
            	}
            }
            button1.label.text = "Continue";
            button1.settings.onTap = () => acceptAction();
        }
        if (number === 3) { 
            actionText.text += "CONSTRUCT\nSUPERPROJECT\n";
            superProjectBack.attentionOn();
            button0.visible = true;
            button0.label.text = "Construct Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Construct Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
    }
        if (number === 4) { 
        	// Remove Anomaly
            if (anomaly.number === 0) {
                actionText.text += "No Anomalies\n";
                failedAction();
            } else if ( neutroniumToken.number >= 1 ||
                uraniumToken.number + goldToken.number + titaniumToken.number >= 2) {
                actionText.text += "Chronobot removed\n Anomaly by discards:\n";

            	let removedResource = 0;

            	let resourcesToBeRemove = [];
            	let maxCount = 0, tempNumber = 0;

            	while ( removedResource < 2 ) {
	            	for( var i = 0; i < resourcesTokens.length; i++ ) {
	            		tempNumber = resourcesTokens[i].number;
	            		//each Neutronium cube is equal to 2 non-Neutronium cubes when calculating priority and discarding
	            		if ( resourcesTokens[i] === neutroniumToken ) {
	            			tempNumber += tempNumber; 
	            		}
	            		if( tempNumber > maxCount ) {
	            			resourcesToBeRemove = [];
	            			resourcesToBeRemove.push( resourcesTokens[i] );
	            			maxCount = tempNumber;
	            		} else if( tempNumber === maxCount ) {
	            			if (!( removedResource > 0 && resourcesTokens[i] === neutroniumToken )) {
	            				//exclude Neutronium
		            			resourcesToBeRemove.push( resourcesTokens[i] );
		            		}
	            		}
	            	}

	        		let discardResource = resourcesToBeRemove[ resourcesToBeRemove.length - 1 ];

					discardResource.remove();
					removedResource += 1;

					actionText.text += discardResource.name + "\n";

					if ( discardResource === neutroniumToken ) {
						removedResource += 1;
					}
				}

                anomaly.remove();
            } else {
                actionText.text += "No Ressources\nto remove Anomaly\n";
                failedAction();
            }
            button1.label.text = "Continue";
            button1.settings.onTap = () => acceptAction();
        }
        if (number === 5) {  
        	// Mine
            actionText.text += "Mine Action\n";
            button0.visible = true;
            button0.label.text = "Mine Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Mine Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (number === 6) { 
        	// Take Power Plant
			// ask if space is free
            actionText.text += "Construct\na Power Plant\n";
            powerPlantBack.attentionOn();
            button0.visible = true;
            button0.label.text = "Construct Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Construct Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (number === 7) {
        	// Recruit
            actionText.text += "Recruit Action\n"
            button0.visible = true;
            button0.label.text = "Recruit Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Recruit Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (number === 8) {  
        	// Take Factory
			// ask if space is free
            actionText.text += "Construct\na Factory\n";
            factoryBack.attentionOn();
            button0.visible = true;
            button0.label.text = "Construct Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Construct Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (number === 9) {  
        	// Reboot
            actionText.text += "Reboot\n"
            button1.label.text = "Continue";
            button1.settings.onTap = () => acceptAction();
        }
        if (number === 10) {  
        	// Recruit Genius / Research
        	/*
        	When using the Recruit Genius/Research Action, perform a Recruit Action only if a Genius is available.
        	If no Genius is available, perform a Research Action instead.
        	*/
            actionText.text += "Recruit Genius\n"
            button0.label.text = "Recruit Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button0.visible = true;
            button1.label.text = "Recruit Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }

        if (number === 11) {
         	// Take Lab
			// ask if space is free
            actionText.text += "Construct a Lab\n";
			labBack.attentionOn();
            button0.visible = true;
            button0.label.text = "Construct Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Construct Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }

        if (number === 12) {
        	// Research
            actionText.text += "Research Action\n";
            button0.visible = true;
            button0.label.text = "Research Spot\nFree";
            button0.settings.onTap = () => spaceFree();
            button1.label.text = "Research Spot\nOccupied";
            button1.settings.onTap = () => spaceOccupied();
        }

    }

    function acceptAction() {
        geniusWorkerFrame.attentionOff();
        workersFrame.attentionOff();
        resourcesFrame.attentionOff();
        action = 0;
        icons.forEach(icon => icon.visible = false);
        if (!finalTimeTravel) tokens[dice - 2].advance();
        button1.visible = true;
        button1.label.text = 'Next\nBot Action';
        actionText.text = "";
        button1.settings.onTap = () => button1Pressed();
        botActions += 1;
        if (botActions >= minActionNum) button2.enable();
        if (exoSuitBack.number === 0) {
            if (finalTimeTravel) {                
                finalTimeTravel = false;
                button1.disable();
                button2.enable();
            }
        }
    }

    function spaceFree() {
    	actionText.text += "Place Exosuit!\n";
        exoSuitBack.remove();
        if (action !== 5) button1.visible = true;

        if (action === 1) {
	       	habitatBack.attentionOff();
        	if (habitatBack.number < habitatBack.limit) {
           		// Need to insert code to ask for construction VP
	            actionText.text += "Take Habitat\n";
	            habitatBack.add(1);
                button1.visible = false;
            } else {
                actionText.text += "max. Habitats\nreached\n";
                failedAction();
			}
        }
        if (action === 3) {
        	superProjectBack.attentionOff();
        	if( superProjectBack.number < superProjectBack.limit ) {
	        	// get most breakthrough shape array and the max count of that shape(s)
	        	let maxValue = 0;
	        	let maxIndexArray = [];
	        	for( i = researchCounter.length - 1; i >= 0; i-- ) {
	        		if ( researchCounter[i].number > maxValue ) {
	        			maxIndexArray = [];
	        			maxIndexArray.push(i);
	        			maxValue = researchCounter[i].number
	        		} else if ( researchCounter[i].number === maxValue ) {
	        			maxIndexArray.push(i);
	        		}
	        	}
	        	// remove breakthrough and perform action
	        	if( maxValue === 0 ) {
	        		actionText.text += "No Breakthrough\n";
	        		failedAction();
	        	} else {
	        		let randomShape = maxIndexArray[ Math.floor(Math.random() * maxIndexArray.length) ];
			        researchCounter[ randomShape ].decrease(1);
			        actionText.text += "Remove a\n" + researchItem[randomShape] + " Breakthrough\n";

                    let breakthroughCount = 0;
                    for( i = 0; i < researchCounter.length; i++ ) {
                        breakthroughCount += researchCounter[i].number;
                    }
                    if( breakthroughCount === 0 ) {
                        for( i = 0; i < researchCounter.length; i++ ) {
                            researchCounter[i].visible = false;
                        }
                        breakthroughBack.visible = false;
                    }

		       		// Need to insert code to ask for Superproject VP       		
		            actionText.text += "Take Superproject\n";
		            superProjectBack.add(1);
                    button1.visible = false;
	        	}
			} else {
                actionText.text += "max. Superproject\nreached\n";
                failedAction();
			}
        }
        if (action === 5) {
        	// Mine
            resourcesFrame.attentionOn();
            actionText.text += "\nTake 2 Resources by\ntapping on board\n";
            neutroniumToken.interactive = true;
            uraniumToken.interactive = true;
            goldToken.interactive = true;
            titaniumToken.interactive = true;
            selectResources = 0;

            /*
            button1.label.text="Continue (2)";
            button1.visible = true;
            button1.settings.onTap = () => acceptAction();                  
            */
            button1.visible = false;
        }
        if (action === 6) {
	       	powerPlantBack.attentionOff();
			if (powerPlantBack.number < powerPlantBack.limit) {
           		// Need to insert code to ask for construction VP
	            actionText.text += "Take Power Plant\n";
	            powerPlantBack.add(1);
                button1.visible = false;
            } else { 
                actionText.text += "max. Power Plants\nreached\n";
                failedAction();
			}
        }
        if (action === 7) {
        	// Recurit
            geniusWorkerFrame.attentionOn();
            workersFrame.attentionOn();
            actionText.text += "Take Worker by\ntapping on board\n";
            adminToken.interactive = true;
            engineerToken.interactive = true;
            scientistToken.interactive = true;
            geniusToken.interactive = true;
            button1.label.text = "No Worker\nAvailable";
            button1.settings.onTap = () => spaceOccupied();
        }
        if (action === 8) {
	       	factoryBack.attentionOff();
			if (factoryBack.number < factoryBack.limit) {
           		// Need to insert code to ask for construction VP
	            actionText.text += "Take Factory\n";
	            factoryBack.add(1);
                button1.visible = false;
            } else { 
                actionText.text += "max. Factories\nreached\n";
                failedAction();
         	}	
        }
        if (action === 10) {
        	// Recurit Genius / Research
            geniusWorkerFrame.attentionOn();
            actionText.text += "Take Genius by\ntapping on board\n";
            geniusToken.interactive = true;
            button1.label.text = "No Genius\nAvailable";
            action = 10.5;
            button1.settings.onTap = () => spaceOccupied();
        }
        if( action === 11) {
	       	labBack.attentionOff();
            if (labBack.number < labBack.limit) {
           		// Need to insert code to ask for construction VP
				actionText.text += "Take Lab\n";
				labBack.add(1);
                button1.visible = false;
			} else {
                actionText.text += "max. Labs\nreached\n"
                failedAction();
            }
        }
        if( action === 12) {
        	// current steps are not correct. Need to show each shape count in the BreakthroughToken.
	        let researchDice = Math.floor(Math.random() * 3);
	        actionText.text += "Took the " + researchItem[researchDice] + "\nBreakthrough Token";
	        researchCounter[researchDice].increase(1);

			for ( i = 0; i < researchCounter.length; i++ ) {
				researchCounter[i].visible = true;
			}

			breakthroughBack.visible = true;

	        button1.label.text = "Continue";
	        button1.settings.onTap = () => acceptAction();        	    	
        }

        button0.visible = false;

    }

    function failedAction() {
    	actionText.text += "Action Failed\n+ 1 VP\n";
    	points.increase(1);
        button0.visible = false;
        button1.label.text = "Continue";
        button1.settings.onTap = () => acceptAction();    	
    }

    function spaceOccupied() {
        if ( action === 1 ) {
            habitatBack.attentionOff();
            failedAction();
        } else if ( action === 3 ) {
            superProjectBack.attentionOff();
            failedAction();
        } else if ( action === 6 ) {
            powerPlantBack.attentionOff();
            failedAction();
        } else if ( action === 7 ) {
            geniusWorkerFrame.attentionOff();
            workersFrame.attentionOff();
            failedAction();
        } else if ( action === 8 ) {
            factoryBack.attentionOff();
            failedAction();
        } else if ( action === 10 ) {
            geniusWorkerFrame.attentionOff();
            workersFrame.attentionOff();
            actionText.text += "No Recurit Space\n";
            action = 12;
            performAction();
        } else if ( action === 10.5 ) {
            geniusWorkerFrame.attentionOff();
    		actionText.text += "No Genius.\n";
	        exoSuitBack.add();
			action = 12;
			performAction();
    	} else if ( action === 11 ) {
            labBack.attentionOff();
            failedAction();
        } else if ( action === 12 ) {
            failedAction();
        }
        else {
    		failedAction();
    	}
    }

    function waitForUser() {
        button2.settings.onTap = () => button2Pressed();
        actionText.visible = false;

        if (phase.number === 2) {
            paradox.deactivateTokens();
            phase.increase(1);
            button2Pressed();
        } else if (phase.number === 3) {
            phase.set(4);
            button2Pressed();
        } else if (phase.number === 4) {
            // draw 0-2 tokens

            let draw = paradox.rollParadoxDice();
            if (draw > warptileNumber) draw = warptileNumber;
            warptileNumber -= draw;
			warpTokensLog.push(draw);
            actionText.text = "Chronobot selects \n " + draw.toString() + "\n warp tile(s)";
            actionText.visible = true;

            phase.set(4.5);
            button2.label.text = "Okay\nNext Phase";
            button2.settings.onTap = () => waitForUser();
        } else if (phase.number === 4.5) {
            phase.number = 4;
            phase.increase(1);
            button2Pressed();
        } else if (phase.number === 5) {
            actionText.text = "Clean Up and\n proceed to next era";
            if (era.number === 4) actionText.text += "\n\nDon't forget the \nIMPACT ";
            actionText.visible = true;
            phase.increase(1);
            if (era.number >= 5) {
                button1.label.text = "End Game";
                button1.enable();
            }
            else button1.visible = false;
            button2.label.text = "Okay\nNext Era";
            button2.settings.onTap = () => waitForUser();
            if (era.number === 7) button2.disable();
        } else if (phase.number === 6) {
            if (era.number === 7) button1Pressed();
            else {
                phase.set(2);
                button1.visible = false;
                era.increase(1);
                button2Pressed();
            }
        }
    }


    function startAutoma() {

        const panel = new PIXI.Sprite(loader.resources['images/sidepanel-up.png'].texture);
        panel.interactive = true;
        //panel.hitArea = new PIXI.Rectangle(10,150,240,700);
        panel.on('pointerdown', helpAsked);
        panel.x = 1480;
        panel.y = 0;
        const buttonPanel = new PIXI.Sprite(loader.resources['images/sidepanel-down.png'].texture);
        buttonPanel.x = 1480;
        buttonPanel.y = 700;

        //const background_image = loader.resources['images/BG-TheWorld.png'].texture;
        //const board = new Board(background_image);
        board.texture = loader.resources['images/BG-TheWorld.png'].texture;
        board.x = 0;
        board.y = 0;

        const action_frame = new PIXI.Sprite(loader.resources['images/Chronobot-2.0-board.png'].texture);

        board.addChild(action_frame);
        board.addChild(advancePath);
        board.addChild(normalPath);

        for (let i = 2; i <= 5; i++) {
            const newToken = new Token(i, PIXI.Texture.from('images/t' + i.toString() + '.png'), states[stateStart[i - 2]]);
            tokens.push(newToken);
            board.addChild(newToken);
        }

        paradox.init(board);

        board.addChild(geniusToken);
        board.addChild(adminToken);
        board.addChild(engineerToken);
        board.addChild(scientistToken);
        board.addChild(geniusWorkerFrame);
        board.addChild(workersFrame);

        board.addChild(neutroniumToken);
        board.addChild(uraniumToken);
        board.addChild(goldToken);
        board.addChild(titaniumToken);
        board.addChild(resourcesFrame);

        board.addChild(timetravelToken);

        const tempVP = [], tempVPTexture = [];
        for( let i = 0; i <= 8; i++ ) {
            tempVP.push( i );
            tempVPTexture.push( loader.resources["images/VictoryPointToken" + i + ".png"].texture );
        }
        powerPlantBack.texture = loader.resources["images/power.png"].texture;
        powerPlantBack.init( tempVP.slice(1,5), tempVPTexture.slice(1,5) );
        board.addChild(powerPlantBack);

        factoryBack.texture = loader.resources["images/factories.png"].texture;
        factoryBack.init( tempVP.slice(1,4), tempVPTexture.slice(1,4) );
        board.addChild(factoryBack);

        habitatBack.texture = loader.resources["images/habitats.png"].texture;
        habitatBack.init( tempVP.slice(1,4), tempVPTexture.slice(1,4) );
        board.addChild(habitatBack);

        labBack.texture = loader.resources["images/lab.png"].texture;
        labBack.init( tempVP.slice(0,5), tempVPTexture.slice(0,5) );        
        board.addChild(labBack);

        superProjectBack.texture = loader.resources["images/superproject.png"].texture;
        superProjectBack.init( tempVP.slice(4,9), tempVPTexture.slice(4,9), TOP_LEFT, VERTICAL );

        board.addChild(superProjectBack);
        board.addChild(exoSuitBack);
        board.addChild(cogWheelIcon);

        anomaly.texture = loader.resources["images/anomaly.png"].texture;
        anomaly.init( [-3], [loader.resources["images/VictoryPointTokenNeg3.png"].texture] );
        board.addChild(anomaly);

        board.addChild(breakthroughBack);
        board.addChild(btCircleCounter);
        board.addChild(btTriangleCounter);
        board.addChild(btSquareCounter);

        panel.addChild(actionText);
        buttonPanel.addChild(button2);
        buttonPanel.addChild(button1);
        buttonPanel.addChild(button0);


        panel.addChild(points);
        panel.addChild(era);
        panel.addChild(phase);


        board.addChild(powerPlantIcon);
        board.addChild(factoryIcon);
        board.addChild(habitatIcon);
        board.addChild(labIcon);
        board.addChild(superprojectIcon);


        automa.stage.addChild(board);
        automa.stage.addChild(panel);
        automa.stage.addChild(buttonPanel);


        phase.set(3);
        button2.label.text = "Start Game";

    }

</script>
</body>
</html>